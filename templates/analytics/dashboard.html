{% extends "base.html" %}

{% block title %}Dashboard - Cross CRM{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="hero-section mb-4">
    <div class="hero-content">
        <h1><i class="bi bi-speedometer2"></i> Dashboard</h1>
        <p>Real-time insights into your sales performance</p>
    </div>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="row g-2">
        <div class="col-auto">
            <input type="date" name="start_date" class="form-control form-control-sm" 
                   value="{{ start_date or '' }}" placeholder="Start Date">
        </div>
        <div class="col-auto">
            <input type="date" name="end_date" class="form-control form-control-sm" 
                   value="{{ end_date or '' }}" placeholder="End Date">
        </div>
        <div class="col-auto">
            <select name="period" class="form-select form-select-sm" onchange="this.form.submit()">
                <option value="7" {% if period == '7' %}selected{% endif %}>Last 7 days</option>
                <option value="30" {% if period == '30' %}selected{% endif %}>Last 30 days</option>
                <option value="90" {% if period == '90' %}selected{% endif %}>Last 90 days</option>
                <option value="365" {% if period == '365' %}selected{% endif %}>Last year</option>
            </select>
        </div>
        <div class="col-auto">
            <button type="submit" class="btn btn-sm btn-primary">Filter</button>
        </div>
        </form>
    </div>
</div>

{% if prev_metrics %}
<div class="alert alert-info">
    <strong>Comparison:</strong> 
    Current period: ${{ "{:,.2f}".format(sales_metrics.total_revenue) }} | 
    Previous period: ${{ "{:,.2f}".format(prev_metrics.total_revenue) }} |
    Change: {{ "{:.1f}".format(((sales_metrics.total_revenue - prev_metrics.total_revenue) / prev_metrics.total_revenue * 100) if prev_metrics.total_revenue > 0 else 0) }}%
</div>
{% endif %}

<div class="row g-3 mb-4">
    <div class="col-lg-3 col-md-6 col-12">
        <div class="card metric-card success">
            <div class="card-body">
                <h6 class="text-muted">Total Revenue</h6>
                <h4>${{ "{:,.2f}".format(sales_metrics.total_revenue) }}</h4>
                <small>{{ sales_metrics.deal_count }} deals</small>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 col-12">
        <div class="card metric-card">
            <div class="card-body">
                <h6 class="text-muted">Pipeline Value</h6>
                <h4>${{ "{:,.2f}".format(pipeline_metrics.total_pipeline_value) }}</h4>
                <small>{{ pipeline_metrics.deal_count }} active deals</small>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 col-12">
        <div class="card metric-card warning">
            <div class="card-body">
                <h6 class="text-muted">Win Rate</h6>
                <h4>{{ "{:.1f}".format(win_rate.win_rate) }}%</h4>
                <small>{{ win_rate.won_deals }} won / {{ win_rate.total_closed }} closed</small>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 col-12">
        <div class="card metric-card">
            <div class="card-body">
                <h6 class="text-muted">Avg Deal Value</h6>
                <h4>${{ "{:,.2f}".format(sales_metrics.average_deal_value) }}</h4>
            </div>
        </div>
    </div>
</div>

<div class="row g-3">
    <div class="col-lg-8 col-md-12">
        <div class="card">
            <div class="card-header">
                <h5>Sales Trends (Last 30 Days)</h5>
            </div>
            <div class="card-body">
                <canvas id="salesTrendChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-4 col-md-12">
        <div class="card">
            <div class="card-header">
                <h5>Top Performers</h5>
            </div>
            <div class="card-body">
                <ul class="list-group list-group-flush" style="background: transparent;">
                    {% for perf in performance[:5] %}
                    <li class="list-group-item" style="background: var(--netflix-dark); border-color: rgba(255,255,255,0.1);">
                        <strong style="color: var(--netflix-white);">{{ perf.user_name }}</strong><br>
                        <small style="color: var(--netflix-text-muted);">${{ "{:,.2f}".format(perf.total_revenue) }} revenue</small>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5>Sales Funnel</h5>
            </div>
            <div class="card-body">
                <canvas id="funnelChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5>Recent Deals</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Value</th>
                                <th>Stage</th>
                                <th>Contact</th>
                                <th>Assigned To</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for deal in recent_deals %}
                            <tr>
                                <td><a href="/deals/{{ deal.id }}">{{ deal.title }}</a></td>
                                <td>${{ "{:,.2f}".format(deal.value) }}</td>
                                <td><span class="badge bg-secondary">{{ deal.stage.value.replace('_', ' ').title() }}</span></td>
                                <td>{{ deal.contact.first_name if deal.contact else '-' }} {{ deal.contact.last_name if deal.contact else '' }}</td>
                                <td>{{ deal.assigned_user.full_name if deal.assigned_user else '-' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
    // Sales trends chart
    const trendsData = {{ trends | tojson }};
    const labels = trendsData.map(t => t.date);
    const revenue = trendsData.map(t => t.revenue);
    
    createLineChart('salesTrendChart', labels, revenue, 'Revenue');
    
    // Sales funnel chart
    const funnelData = {
        'Prospecting': {{ pipeline_metrics.deal_counts.prospecting or 0 }},
        'Qualification': {{ pipeline_metrics.deal_counts.qualification or 0 }},
        'Proposal': {{ pipeline_metrics.deal_counts.proposal or 0 }},
        'Negotiation': {{ pipeline_metrics.deal_counts.negotiation or 0 }},
        'Closed Won': {{ pipeline_metrics.deal_counts.closed_won or 0 }}
    };
    
    createBarChart('funnelChart', Object.keys(funnelData), Object.values(funnelData), 'Deals by Stage');
</script>
{% endblock %}
{% endblock %}

